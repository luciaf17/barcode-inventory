<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingresar datos de producto</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="formularios">
    <div class="form-container">
        <h1>Ingresar datos de producto</h1>
        <form id="data-form">
            <input type="hidden" id="code" name="code" value="{{ code }}">

            <label for="cantidad">Cantidad:</label>
            <input type="number" id="cantidad" name="cantidad" value="{{ ultimo_producto.cantidad if ultimo_producto else '' }}" required>

            <label for="deposito">Depósito:</label>
            <select id="deposito" name="deposito" required>
                {% for deposito in depositos %}
                    <option value="{{ deposito }}" {% if ultimo_producto and ultimo_producto.deposito == deposito %}selected{% elif loop.first %}selected{% endif %}>{{ deposito }}</option>
                {% endfor %}
            </select>

            <label for="pasillo">Pasillo:</label>
            <select id="pasillo" name="pasillo" required>
                {% for pasillo in pasillos %}
                    <option value="{{ pasillo }}" {% if ultimo_producto and ultimo_producto.pasillo == pasillo %}selected{% elif loop.first %}selected{% endif %}>{{ pasillo }}</option>
                {% endfor %}
            </select>

            <label for="columna">Columna:</label>
            <select id="columna" name="columna" required>
                {% for columna in columnas %}
                    <option value="{{ columna }}" {% if ultimo_producto and ultimo_producto.columna == columna %}selected{% elif loop.first %}selected{% endif %}>{{ columna }}</option>
                {% endfor %}
            </select>

            <label for="estante">Estante:</label>
            <select id="estante" name="estante" required>
                {% for estante in estantes %}
                    <option value="{{ estante }}" {% if ultimo_producto and ultimo_producto.estante == estante %}selected{% elif loop.first %}selected{% endif %}>{{ estante }}</option>
                {% endfor %}
            </select>

            <div>
                <label for="descripcion">Descripción:</label>
                <input type="text" id="descripcion" name="descripcion" placeholder="Ingrese la descripción">
            </div>

            <button type="submit" class="submit-button">Enviar</button>
        </form>

        <div id="message-container"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            document.getElementById('code').value = code || ""; 

            if (code) {
                const depositoOriginal = document.getElementById("deposito").value;
                const pasilloOriginal = document.getElementById("pasillo").value;
                const columnaOriginal = document.getElementById("columna").value;
                const estanteOriginal = document.getElementById("estante").value;

                fetch(`/verificar_producto?code=${code}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.producto) {
                            document.getElementById("cantidad").value = data.producto.cantidad || "";
                            document.getElementById("deposito").value = data.producto.deposito || depositoOriginal;
                            document.getElementById("pasillo").value = data.producto.pasillo || pasilloOriginal;
                            document.getElementById("columna").value = data.producto.columna || columnaOriginal;
                            document.getElementById("estante").value = data.producto.estante || estanteOriginal;
                            document.getElementById("descripcion").value = data.producto.descripcion || "";
                        }
                    });
            }
        });

        document.getElementById('data-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const code = document.getElementById("code").value;
            const cantidad = document.getElementById("cantidad").value;
            const deposito = document.getElementById("deposito").value;
            const pasillo = document.getElementById("pasillo").value;
            const columna = document.getElementById("columna").value;
            const estante = document.getElementById("estante").value;
            const descripcion = document.getElementById("descripcion").value;
            const messageContainer = document.getElementById("message-container");  // Corregido aquí

            fetch('/agregar', {  // Cambiado a /agregar
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code, cantidad, deposito, pasillo, columna, estante, descripcion })
            })
            .then(response => response.json())
            .then(data => {
                messageContainer.classList.remove("success", "error");
                if (data.error) {
                    messageContainer.classList.add("error");
                    messageContainer.innerText = data.error;
                } else {
                    messageContainer.classList.add("success");
                    messageContainer.innerText = data.message;
                }
            })
            .catch(error => {
                console.error("Error:", error);
                messageContainer.classList.add("error");
                messageContainer.innerText = "Hubo un error al enviar los datos.";
            });
        });
    </script>
</body>
</html>
